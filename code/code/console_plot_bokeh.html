<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Console Python avec Bokeh (Finalis√©)</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
    <script src="https://cdn.bokeh.org/bokeh/release/bokeh-3.4.1.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.6; margin: 20px; background-color: #f8f9fa; }
        h1, h2 { color: #343a40; }
        #container { display: flex; gap: 20px; }
        #left-panel { flex: 1; }
        #right-panel { flex: 1; border-left: 1px solid #dee2e6; padding-left: 20px; }
        textarea { width: 98%; height: 200px; font-family: monospace; font-size: 14px; border: 1px solid #ced4da; border-radius: 4px; padding: 10px; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        #output-area { background-color: #e9ecef; border-radius: 4px; padding: 10px; min-height: 50px; white-space: pre-wrap; font-family: monospace; }
        #plot-area { border: 1px solid #dee2e6; border-radius: 4px; margin-top: 10px; min-height: 300px; }
        #status { color: #6c757d; }
    </style>
</head>
<body>
    <h1>üêç Console Python avec NumPy & Bokeh</h1>
    <p id="status">Chargement de Pyodide...</p>

    <div id="container">
        <div id="left-panel">
            <h2>Code</h2>
            <textarea id="code-input">
# Import des biblioth√®ques
import numpy as np
from bokeh.plotting import figure

# Cr√©ation des donn√©es
x = np.linspace(0, 2 * np.pi, 400)
y = np.sin(x ** 2)

# Cr√©ation du graphique Bokeh
# NOTE: Le graphique doit √™tre dans une variable nomm√©e `p`
p = figure(
    title="Graphique Bokeh interactif",
    height=350,
    sizing_mode="stretch_width"
)
p.line(x, y, legend_label="sin(x^2)", line_width=2)

# La variable 'p' est automatiquement d√©tect√©e
            </textarea>
            <button id="execute-button" disabled>Ex√©cuter</button>
            <h2>Sortie Texte / Erreurs</h2>
            <pre id="output-area"></pre>
        </div>
        <div id="right-panel">
            <h2>Graphique Interactif</h2>
            <div id="plot-area"></div>
        </div>
    </div>

<script>
async function main() {
    const status = document.getElementById('status');
    const codeInput = document.getElementById('code-input');
    const executeButton = document.getElementById('execute-button');
    const outputArea = document.getElementById('output-area');
    const plotArea = document.getElementById('plot-area');

    status.textContent = 'Installation de NumPy, Pandas et Bokeh...';
    let pyodide = await loadPyodide();
    await pyodide.loadPackage(['numpy', 'pandas', 'bokeh']);
    
    status.textContent = 'Pr√™t ! Vous pouvez ex√©cuter votre code.';
    executeButton.disabled = false;

    // Le script Python qui ex√©cutera le code utilisateur de mani√®re s√©curis√©e
    const pythonExecutor = `
import json
from bokeh.embed import json_item
from bokeh.models import Model
import io
import sys

# La variable 'user_code' est d√©finie par \`pyodide.globals.set\`
# C'est ici que le code de l'utilisateur est r√©cup√©r√©.

# Redirige stdout pour capturer les \`print\` et les erreurs
stdout_capture = io.StringIO()
sys.stdout = stdout_capture
sys.stderr = stdout_capture # Capture les erreurs dans le m√™me flux

plot_json = None
# Cr√©e un dictionnaire pour servir de port√©e (scope) locale au code ex√©cut√©
scope = {}

try:
    # Ex√©cute le code de l'utilisateur dans une port√©e contr√¥l√©e
    exec(user_code, globals(), scope)

    # Cherche le graphique 'p' dans la port√©e o√π le code a √©t√© ex√©cut√©
    if 'p' in scope and isinstance(scope['p'], Model):
        plot_json = json.dumps(json_item(scope['p'], "plot-area"))

except Exception as e:
    # Affiche l'erreur en cas de probl√®me
    print(e)
finally:
    # R√©initialise stdout quoi qu'il arrive
    sys.stdout = sys.__stdout__

# Retourne un objet JSON avec les r√©sultats
json.dumps({
    "stdout": stdout_capture.getvalue(),
    "plot_json": plot_json
})
    `; // <-- Point-virgule ajout√© ici

    executeButton.addEventListener('click', async () => {
        outputArea.textContent = '';
        plotArea.innerHTML = ''; 
        
        try {
            // Rend le code de l'utilisateur disponible pour le script Python
            pyodide.globals.set('user_code', codeInput.value);
            
            // Ex√©cute notre script "wrapper"
            const results = await pyodide.runPythonAsync(pythonExecutor);
            const { stdout, plot_json } = JSON.parse(results);

            if (stdout) {
                outputArea.textContent = stdout;
            }

            if (plot_json) {
                const plotData = JSON.parse(plot_json);
                Bokeh.embed.embed_item(plotData);
            } else if (!stdout) {
                outputArea.textContent = "Code ex√©cut√© avec succ√®s (pas de sortie texte ni de graphique).";
            }

        } catch (error) {
            outputArea.textContent = error.toString();
        }
    });
}

main();
</script>

</body>
</html>